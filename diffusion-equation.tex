\section{The Diffusion Equation}
\label{sec:Diffusion}

The diffusion equation is derived from the \gls{nte} by making some simplifying assumptions regarding the angular dependence of the angular flux. Before we reach this conclusion, however, we should explore two possible methods in which we might obtain a \gls{pde} strictly in terms of the scalar flux \(\phi\) and scalar current \(\vv{J}\), defined as:

\beq
\label{eq:ScalarFluxDef}
\phi\sset\equiv\int_{4\pi}d\hO\psi\seat
\eeq

\beq
\label{eq:Current}
\vv{J}(\vv{r},E,t)\equiv\int_{4\pi}^{}d\hO  \vv{j}\seat
\eeq

where \(\vv{j}\) is the angular current:

\beq
\label{eq:AngularCurrent}
\vv{j}\spa = \psi\spa\hO  
\eeq

Our first attempt to obtain an equation solely in terms of \(\phi\) will be to integrate the \gls{nte} in Eq. \eqref{eq:nte1} over angle, using the definitions of scalar flux and current in Eqs. \eqref{eq:ScalarFluxDef} and \eqref{eq:Current}:

\beqa
\label{eq:NeutronContinuityEquation}
&\frac{\partial}{\partial t}\left(\frac{\phi\sset}{v(E)}\right)+\nabla\cdot\vv{J}\sset+\Sigma_t\sset\phi\sset=\\
&\hspace{1cm}\int_{4\pi}d\hO\inscatteringsource\psi\seatelse+\\
&\hspace{2cm}\chi_p(E)\left(1-\beta\right)\dEprime\nu(E')\Sigma_f(\vv{r},E',t)\phi(\vv{r},E',t)+\\
&\hspace{3cm}\sum_{j=1}^J\chi_{d,j}(E)\lambda_jC_j(\vv{r},t)+S\sset
\eeqa

The time term is obtained by expanding via the chain rule, integrating in angle (by noting that the time derivative can be brought outside the integral due to its lack of dependence on angle, and then brought back in after introducing \(\phi\)), and collapsing the chain rule. The streaming term is written as an area integral by reversing the divergence rule, and then re-applying the divergence rule after angle integration. The fission and total cross sections have been assumed independent of angle such that they could be brought outside the angle integration, as is commonplace. 

The inscattering source term requires additional effort to switch the order of integration of \(\hO'\) and \(\hO\). By assuming rotational symmetry such that Eq. \eqref{eq:OmegaDotOmega} holds, the single differential scattering cross section is defined by integrating over \(\hO\):

\beqa
\label{eq:SingleDifferentialSigma_s}
\Sigma_s(\vv{r},E'\rightarrow E,t)\equiv&\int_{4\pi}d\hO \Sigma_s\seatout\\
=&\ 2\pi\int_{-1}^1d\mu\Sigma_s(\vv{r},E'\rightarrow E,\mu,t)
\eeqa

Switching the order of angle integrations in the in-scattering term and inserting the definition in Eq. \eqref{eq:SingleDifferentialSigma_s} gives:

\beqa
\label{eq:NeutronContinuityEquation1}
&\frac{\partial}{\partial t}\left(\frac{\phi\sset}{v(E)}\right)+\nabla\cdot\vv{J}\sset+\Sigma_t\sset\phi\sset=\\
&\hspace{1cm}\dEprime\Sigma_s(\vv{r},E'\rightarrow E,t)\phi(\vv{r},E',t)+\\
&\hspace{2cm}\chi_p(E)\left(1-\beta\right)\dEprime\nu(E')\Sigma_f(\vv{r},E',t)\phi(\vv{r},E',t)+\\
&\hspace{3cm}\sum_{j=1}^J\chi_{d,j}(E)\lambda_jC_j(\vv{r},t)+S\sset
\eeqa

Eq. \eqref{eq:NeutronContinuityEquation1} is sometimes referred to as the ``neutron continuity'' equation, since it represents an equivalent statement of neutron conservation, similar to mass conservation in fluid mechanics and the ``mass continuity'' equation. Note that attempting to integrate out all angular dependence has introduced \(\vv{J}\), which has no exact relationship with \(\phi\). We will seek a \gls{pde} that is a function of strictly \(\vv{J}\), rather than both \(\vv{J}\) and \(\phi\), by multiplying the \gls{nte} by \(\hO\) and then integrating in angle. Because \(\hO\) is a vector, this corresponds to the multiplication of the \gls{nte} by each component of \(\hO\) and summing. 

\beqa
\label{eq:TEAngleAngleIntegrated2}
&\frac{\partial}{\partial t}\left(\frac{\vv{J}\sset}{v(E)}\right)+\nabla\cdot\int_{4\pi}d\hO\psi\seat\hO\hO+\Sigma_t\sset\vv{J}\sset=\\
&\hspace{1cm}\int_{4\pi}d\hO\inscatteringsource\psi(\vv{r},E',\hO',t)\hO\ +\\
&\hspace{2cm}\left(1-\beta\right)\int_{4\pi}d\hO\chi_p(E,\hO)\hO\dEprime\nu(E')\Sigma_f(\vv{r},E',t)\phi(\vv{r},E',t)\ +\\
&\hspace{3cm}\int_{4\pi}d\hO\hO\delayedfissionsource+\int_{4\pi}d\hO S\seat\hO
\eeqa

The time term is obtained by expanding via the chain rule, integrating in angle (by noting that the time derivative can be brought outside the integral due to its lack of dependence on angle, and then brought back in after introducing \(\phi\)), and collapsing the chain rule. The gradient in the streaming term is brought outside the angular integral because the operator is independent of angle. Again, the total and fission cross sections are assumed independent of angle such that they can be brought outside the angle integration, with the definition of scalar flux in Eq. \eqref{eq:ScalarFluxDef} used in the fission source term. If the prompt and/or delayed fission spectra are isotropic, then the first moments of \(\chi_p\) and \(\chi_d\) are zero, and the fission source terms are zero. Likewise, the external source integral represents the first moment of the external source, which will be zero if the external source is isotropic.

The inscattering source term again requires some additional effort and tracking of the multiplication by each component of \(\hO\). The \(x\)-component multiplication, with the angle order of integration swapped, reads as:

\beq
\label{eq:Inscat1}
\int_{4\pi}d\hO'\dEprime \int_{4\pi}d\hO\Sigma_s\seatout\psi\seatelse\Omega_x
\eeq

Because \(\hO\) and \(\hO'\) are unit vectors, Eq. \eqref{eq:Inscat1} can be multiplied by \(\hO'\cdot\hO'\equiv1\):

\beq
\label{sec:Inscat1}
\int_{4\pi}d\hO'\dEprime \int_{4\pi}d\hO\Sigma_s\seatout\psi\seatelse\Omega_x\hO'\cdot\hO'
\eeq

Assuming rotational symmetry such that \(\Sigma_s\) depends on \(\hO\cdot\hO'\) rather than the initial and final angle states individually, we express \(\Sigma_s\) in terms of \(\mu\) and write \(\hO'\cdot\hO'\) as \(\Omega'_i\Omega'_i\), where \(i=x\), \(y\), and \(z\), which can be written solely in terms of the \(x\)-component by including an extra factor of 3:

\beq
\label{sec:Inscat2}
3\int_{4\pi}d\hO'\dEprime \int_{4\pi}d\hO\Sigma_s(\vv{r},E'\rightarrow E,\hO'\cdot\hO,t)\psi\seatelse\Omega_x\Omega'_x\Omega'_x
\eeq

Now, by recognizing that the dot product between directions of motion can be reversed from \(\hO\cdot\hO'\) to \(\hO'\cdot\hO\) gives the following:

\beq
\label{eq:Inscat2}
\dEprime \Sigma_{s,1}(\vv{r},E'\rightarrow E,t)\vv{J}(\vv{r},E',t)
\eeq

where the definition of current from Eq. \eqref{eq:Current} has been used and the first moment of the scattering cross section is defined in Eq. \eqref{eq:ScatteringMomentsLegendre} with \(l=1\). Combining Eq. \eqref{eq:TEAngleAngleIntegrated2} with the form of the in-scattering source in Eq. \eqref{eq:Inscat2} gives:

\beqa
\label{eq:TEAngleAngleIntegrated2v2}
&\frac{\partial}{\partial t}\left(\frac{\vv{J}\sset}{v(E)}\right)+\nabla\cdot\int_{4\pi}d\hO\psi\seat\hO\hO+\Sigma_t\sset\vv{J}\sset=\\
&\hspace{1cm}\dEprime \Sigma_{s,1}(\vv{r},E'\rightarrow E,t)\vv{J}(\vv{r},E',t)+\\
&\hspace{2cm}\left(1-\beta\right)\int_{4\pi}d\hO\chi_p(E,\hO)\hO\dEprime\nu(E')\Sigma_f(\vv{r},E',t)\phi(\vv{r},E',t)+\\
&\hspace{3cm}\int_{4\pi}d\hO\hO\delayedfissionsource+\int_{4\pi}d\hO S\seat\hO
\eeqa

Attempting to obtain an equation solely in terms of \(\vv{J}\) has been unsuccessful due to the streaming term. Because the streaming term is the only term that contains a factor of \(\hO\), each multiplication by \(\hO\) and integration over angle will introduce a new term that cannot be expressed analytically in terms of \(\vv{J}\) or \(\phi\). So, an equation in terms of \(\vv{J}\) or \(\phi\) alone cannot be derived by simply integrating angular dependence from the \gls{nte} or by performing other tricks like first multiplying by \(\hO\) and then integrating over angle. An explicit assumption regarding the angular dependence of the angular flux must be made. The diffusion equation is derived from the angle-integrated \gls{nte} in Eq. \eqref{eq:NeutronContinuityEquation1} by assuming a P$_{1}$ expansion for the angular dependence of the angular flux according to the form in Eq. \eqref{eq:ScatteringLegendre}:

\beqa
\label{eq:FluxLegendreP1}
\psi\seat\approx&\sum_{l=0}^1\frac{2l+1}{4\pi}\psi_l\sset P_l(\hO)\\
=&\frac{1}{4\pi}\psi_0\sset+\frac{3}{4\pi}\psi_1\sset\hO\\
\eeqa
%\frac{1}{4\pi}\phi\sset+\frac{3}{4\pi}\vv{J}\sset\hO

where \(\psi_l\) is the \(l\)-th moment of the angular flux. Based on the definitions of the first few Legendre polynomials in Eq. \eqref{eqn:LegendrePolynomials_P0P1P2}, a P$_1$ approximation is equivalent to assuming linear anisotropy in the angular flux, which is reasonably accurate if the angular flux is only weakly dependent on angle. To interpret the physical meaning of the flux moments \(\psi_0\) and \(\psi_1\), integrate Eq. \eqref{eq:FluxLegendreP1} over angle:

\beqa
\label{eq:FluxLegendreP1_AngleIntegration}
\int_{4\pi}^{} d\hO\psi\seat=& \frac{1}{4\pi}\int_{4\pi}^{}d\hO\psi_0\sset +\frac{3}{4\pi}\int_{4\pi}^{} d\hO \psi_1\sset\hO\\
\phi\spas = &\ \psi_0 + \frac{3}{4\pi}\psi_1\int_{4\pi}^{} d\hO  \hO\\
   = &\ \psi_0
\eeqa

where Eqs. \eqref{eq:SolidAngleIntegration} and \eqref{eq:OmegaCartesianIntegration} have been used. Eq. \eqref{eq:FluxLegendreP1_AngleIntegration}  shows that the zero-th moment of the angular flux is equivalent to the scalar flux. In other words, the scalar flux represents the angular flux with all angular dependence ``averaged out.'' This is also self-evident from the definition of the scalar flux in Eq. \eqref{eq:ScalarFluxDef}. To interpret \(\psi_1\), multiply Eq. \eqref{eq:FluxLegendreP1} by \(\hO\) and then integrate over solid angle:

\beqa
\label{eq:FluxLegendreP1_AngleIntegration2}
\int_{4\pi}^{} d\hO   \hO  \psi\spa  =& \frac{1}{4\pi}\int_{4\pi}^{} d\hO   \hO  \psi_0\sset + \frac{3}{4\pi}\int_{4\pi}^{} d\hO   \hO   \hO  \psi_1\sset\\
\vv{J}\sset = &\ \psi_1\sset\\
\eeqa

where Eqs. \eqref{eq:OmegaCartesianIntegration} and \eqref{eq:4PiOmegaOmega} have been used. Eq. \eqref{eq:FluxLegendreP1_AngleIntegration2} shows that the first moment of the angular flux is equivalent to the current. This is also self-evident from the definition of the scalar current in Eq. \eqref{eq:Current}. Inserting the expansion in Eq. \eqref{eq:FluxLegendreP1} into Eq. \eqref{eq:TEAngleAngleIntegrated2v2} for \(\psi\) gives:

\beqa
\label{eq:P1a}
&\frac{\partial}{\partial t}\left(\frac{\vv{J}\sset}{v(E)}\right)+\frac{1}{3}\nabla\phi(\vv{r},E,t)+\Sigma_t\sset\vv{J}\sset=\\
&\hspace{1cm}\dEprime \Sigma_{s,1}(\vv{r},E'\rightarrow E,t)\vv{J}(\vv{r},E',t)+\\
&\hspace{2cm}\left(1-\beta\right)\int_{4\pi}d\hO\chi_p(E,\hO)\hO\dEprime\nu(E')\Sigma_f(\vv{r},E',t)\phi(\vv{r},E',t)+\\
&\hspace{3cm}\int_{4\pi}d\hO\hO\delayedfissionsource+\int_{4\pi}d\hO S\seat\hO
\eeqa

where Eqs. \eqref{eq:4PiOmegaOmega} and \eqref{eq:4PiOmegaOmegaOmega} have been used to simplify the streaming term. When combined with the neutron continuity equation in Eq. \eqref{eq:NeutronContinuityEquation1} (which makes no assumptions regarding expansion of the angular dependence of the angular flux), Eqs. \eqref{eq:P1a} and \eqref{eq:NeutronContinuityEquation1} are equivalent to the P$_{1}$ equations, since the approximation of linearly anisotropic angular dependence in the angular flux is equivalent to a first-order expansion in Legendre polynomials in the one-dimensional space \(\hO=\mu\hat{k}\). 

Rather than solve Eqs. \eqref{eq:NeutronContinuityEquation1} and \eqref{eq:P1a} in a coupled sense for four unknowns (\(\phi\) and three components of \(\vv{J}\)), two additional simplifications will yield a single equation in terms of \(\phi\) alone, known as the diffusion equation. To obtain the diffusion equation, we assume that the prompt fission neutron, delayed neutron, and external sources are isotropic such that the first moments of the fission and external sources that appear in Eq. \eqref{eq:P1a} are zero. We also assume that the time rate of change of the current relative to the total interaction rate is negligible such that the time-dependent term in Eq. \eqref{eq:P1a} can be neglected:

\beq
\frac{\partial}{\partial t}\left(\frac{\vv{J}(\vv{r},E,t)}{v(E)}\right)\ll\Sigma_t(\vv{r},E,t)\vv{J}(\vv{r},E,t)
\eeq

Combining these two assumptions simplifies Eq. \eqref{eq:P1a} to:

\beq
\label{eq:P1b}
\frac{1}{3}\nabla\phi(\vv{r},E,t)+\Sigma_t\sset\vv{J}\sset=\dEprime \Sigma_{s,1}(\vv{r},E'\rightarrow E,t)\vv{J}(\vv{r},E',t)
\eeq

Eq. \eqref{eq:P1b} can be reorganized to give an expression for \(\vv{J}\) in terms of \(\phi\) to remove \(\vv{J}\) as an independent variable in Eq. \eqref{eq:NeutronContinuityEquation1}. If scattering were isotropic in the lab frame, \(\Sigma_{s,1}=0\), and Eq. \eqref{eq:P1b} would simplify nicely to a relationship between \(\vv{J}\) and \(\phi\). However, isotropic scattering is far too simple an approximation for most nuclear engineering systems, so instead we define an energy-dependent diffusion coefficient \(D\):

\beq
\label{eq:DiffusionCoeff}
D(\vv{r},E,t)\equiv\frac{1}{3}\left\lbrack\Sigma_t(\vv{r},E,t)-\frac{\dEprime \Sigma_{s,1}(\vv{r},E'\rightarrow E,t)J_i(\vv{r},E',t)}{J_i(\vv{r},E,t)}\right\rbrack^{-1}
\eeq

which gives the diffusion-like relationship between flux and current:

\beq
\label{eq:FicksLaw}
\vv{J}=-D\nabla\phi
\eeq

No exact relationship exists between \(\vv{J}\) and \(\phi\) - the relationships shown in Eqs. \eqref{eq:DiffusionCoeff} and \eqref{eq:FicksLaw} arise from the P$_{1}$ equations (which assumes a certain level of angular anisotropy) with the additional assumption of isotropic sources and small time rate of change of the current. The definition of the diffusion coefficient in Eq. \eqref{eq:DiffusionCoeff} is not particularly useful, since its definition depends on the current, which is unknown. A simpler expression can be obtained by assuming that the contribution to the energy transfer in a scattering collision is purely isotropic, that is:

\beq
\label{eq:IsotropicEnergyTransfer}
\Sigma_{s,1}(\vv{r},E'\rightarrow E,t)=\Sigma_{s,1}(\vv{r},E,t)\delta(E'-E)
\eeq

Inserting Eq. \eqref{eq:IsotropicEnergyTransfer} into Eq. \eqref{eq:DiffusionCoeff} gives an explicit expression for the diffusion coefficient:

\beqa
\label{eq:DiffusionCoeff2}
D(\vv{r},E,t)=&\frac{1}{3}\left\lbrack\Sigma_t(\vv{r},E,t)-\frac{\dEprime \bar{\mu}\Sigma_{s}(\vv{r},E,t)\delta(E'-E)J_i(\vv{r},E',t)}{J_i(\vv{r},E,t)}\right\rbrack^{-1}\\
=&\frac{1}{3\left\lbrack\Sigma_t(\vv{r},E,t)-\bar{\mu}\Sigma_{s}(\vv{r},E,t)\right\rbrack}\\
\eeqa

where \(\bar{\mu}\) is the average of the cosine of the scattering angle weighted with respect to the total scattering cross section:

\beqa
\label{eq:AverageMuDef}
\bar{\mu}\equiv&\langle\mu\rangle\\
=&\frac{\int_{-1}^1d\mu\ \Sigma_s(\vv{r},E,\mu,t)\mu}{\int_{-1}^1d\mu\ \Sigma_s(\vv{r},E,\mu,t)}\\
=&\frac{\Sigma_{s,1}(\vv{r},E,t)}{\Sigma_s(\vv{r},E,t)}
\eeqa

% TODO: Eqatuions 4-127 through 4-129 after reading earlier chapters
Nuclides with more significant forward scattering, such as the lighter elements, will have larger diffusion coefficients. Corrections may be made to the simpler diffusion coefficient in Eq. \eqref{eq:DiffusionCoeff2} to better account for anisotropic energy transfer in scattering. Inserting Eq. \eqref{eq:FicksLaw} into Eq. \eqref{eq:NeutronContinuityEquation1} gives the diffusion equation:

\beqa
\label{eq:DiffusionEquation}
&\frac{\partial}{\partial t}\left(\frac{\phi(\vv{r},E,t)}{v(E)}\right)-\nabla\cdot\left\lbrack D(\vv{r},E,t)\nabla\phi(\vv{r},E,t)\right\rbrack+\Sigma_t\sset\phi\sset=\\
&\hspace{1cm}\dEprime\Sigma_s(\vv{r},E'\rightarrow E,t)\phi(\vv{r},E',t)+\\
&\hspace{2cm}\left(1-\beta\right)\chi_p(E)\dEprime\nu(E')\Sigma_f(\vv{r},E',t)\phi(\vv{r},E',t)+\\
&\hspace{3cm}\sum_{j=1}^J\chi_{d,j}(E)\lambda_jC_j(\vv{r},t)+S\sset
\eeqa

Several assumptions were made in the mathematical derivation of the diffusion equation. These are summarized here as follows:

\begin{enumerate}
\item The angular flux is only linearly dependent on angle due to the use of the P$_{1}$ approximation for the angular flux dependence. For this reason, the diffusion approximation is typically invalid near boundaries or regions with large variation in cross section that induce a stronger directional dependence in the angular flux.
\item The rate of change of the current is much smaller than the characteristic time scale of nuclear interactions.
\item Highly anisotropic fission neutron and external sources.
\end{enumerate}

The use of a Fick's law approximation implies that neutron collisions occur sufficiently frequently that they are well-approximated as a diffusive process. For very heterogeneous media, where the \gls{mfp} is on the same scale as important geometrical features, neutrons may stream large distances relative to the characteristic dimensions of the problem. For this reason, the diffusion approximation is typically invalid when the neutron \gls{mfp} is larger than the characteristic dimensions of the system.

A transport cross section is commonly defined as:

\beq
\label{eq:TransportSigma}
\Sigma_{tr}(\vv{r},E,t)\equiv\Sigma_t(\vv{r},E,t)-\bar{\mu}\Sigma_s(\vv{r},E,t)
\eeq

The transport mean free path, or \(1/\Sigma_{tr}\), is essentially a corrected mean free path that accounts for anisotropies in the elastic scattering process. Because neutrons are biased towards forward scattering, the transport mean free path is larger than the actual mean free path \(1/\Sigma_t\). 

\subsection{Boundary Conditions}

The \glspl{bc} for the diffusion equation will be derived from those for the \gls{nte} shown in Eq. \eqref{eq:NTEBCs}. At interfaces of two different cross sections \(1\) and \(2\), continuity of the angular flux cannot be exactly satisfied. However, integration of Eq. \eqref{eq:NTE_interface} with respect to solid angle, and multiplication by \(\hO\) and integration with respect to solid angle, shows that, at a minimum, diffusion theory can require the first two moments of the angular flux to be continuous at interfaces:

\beq
\phi_1(\vv{r}_s,E,t)=\phi_2(\vv{r}_s,E,t)
\eeq

\beq
\label{eq:ContinuityCurrent}
\vv{J}_1(\vv{r}_s,E,t)=\vv{J}_2(\vv{r}_s,E,t)
\eeq

If a thin source of neutrons is present at an interface boundary, Eq. \eqref{eq:ContinuityCurrent} is modified so that the dot product of the difference in the currents equals the magnitude of the source:

\beq
\left\lbrack\vv{J}_1(\vv{r}_s,E,t)-\vv{J}_2(\vv{r}_s,E,t)\right\rbrack\cdot\hat{n}=S(\vv{r}_s,E,t)
\eeq

At vacuum boundaries, transport theory requires \(\psi_{inc}=0\) for \(\hO\cdot\hat{n}<0\). Similar to continuity of the scalar flux and current, diffusion theory can only satisfy this \gls{bc} in an average sense:

\beqa
\label{eq:DiffusionVacuumBC}
\int_{\hO\cdot\hat{n}<0}d\hO\psi(\vv{r}_s,E,\hO,t)\hO\cdot\hat{n}=&\ 0\\
\vv{J}_{-}(\vv{r}_s,E,t)=&\ 0\\
\eeqa

where the definition of current from Eq. \eqref{eq:Current} has been used, and a subscripted notation of \(\pm\) is used to indicate the outward (\(+\)) or inward (\(-\)) current:

\begin{subequations}
\label{eq:PartialCurrentDef}
\begin{eqnarray}
\vv{J}_+(\vv{r},E,t)&\equiv&\int_{\hO\cdot\hat{n}>0}d\hO\psi\seat\hO\cdot\hat{n}\\
\vv{J}_-(\vv{r},E,t)&\equiv&\int_{\hO\cdot\hat{n}<0}d\hO\psi\seat\hO\cdot\hat{n}
\end{eqnarray}
\end{subequations}

The diffusion theory equivalent of the transport vacuum \gls{bc} of zero incoming flux in Eq. \eqref{eq:DiffusionVacuumBC} is obtained as a function of \(\phi\) by finding the partial currents \(\vv{J}_\pm\) as a function of \(\phi\) by inserting the \(P_1\) approximation in Eq. \eqref{eq:FluxLegendreP1} into Eq. \eqref{eq:PartialCurrentDef}:

\beqa
\label{eq:PartialCurrent_BC1}
\vv{J}_\pm\sset=&\int_{2\pi\pm}d\hO\left\lbrack\frac{1}{4\pi}\phi\sset-\frac{3}{4\pi}D\nabla\phi\sset\hO\right\rbrack\hO\cdot\hat{n}\\
=&\frac{1}{4}\phi\sset\mp\frac{1}{2}D\nabla\phi\sset\cdot\hat{n}
\eeqa

where \(2\pi\pm\) has replaced integration over the entire solid angle \(4\pi\) because the outgoing or incoming directions each correspond to half of the \(\theta\) direction. Inserting the diffusion approximation in Eq. \eqref{eq:FicksLaw} and recognizing that integration over half the solid angle results in Eqs. \eqref{eq:SolidAngleIntegration} and \eqref{eq:OmegaDotOmega} being halved gives the final simple form in terms of \(\phi\) alone. Eq. \eqref{eq:PartialCurrent_BC1} implies that if we linearly extrapolated the flux from the surface based on the value of the gradient at the surface, the flux is zero at a distance \(2D\) along the normal from the surface. Therefore, Eq. \eqref{eq:PartialCurrent_BC1} is frequently used in a simpler form as a Dirichlet \gls{bc}:

\beq
\phi(\vv{r}_s+2D\hat{n},E,t)=0
\eeq

Additional corrections from transport theory suggest that the extrapolation distance of \(2D\) for plane geometries is better replaced by \(0.7104/\Sigma_{tr}\). 

\subsection{The Multigroup Diffusion Equation}

The diffusion equation in Eq. \eqref{eq:DiffusionEquation} can be written in \gls{mg} form by integrating over energy group \(E_{g}\leq E\leq E_{g-1}\) as was performed in the derivation of the \gls{mg} transport equation in Section \ref{sec:MGNTE}. Similar to the definitions provided in Section \ref{sec:MGNTE} for groupwise fluxes and cross sections, the groupwise flux and cross sections are defined here as:

\beq
\label{eq:FluxGroup}
\phi_g(\vv{r},t)\equiv\int_{E_{g}}^{E_{g-1}}dE\phi(\vv{r},E,t)
\eeq

\beq
\label{eq:SigmaGroup}
\Sigma_{i,g}(\vv{r},t)\equiv\frac{1}{\phi_g(\vv{r},t)}\int_{E_{g}}^{E_{g-1}}dE\Sigma_i(\vv{r},E,t)\phi(\vv{r},E,t)
\eeq

\beq
\label{eq:ScatGroup}
\Sigma_{s,g'\rightarrow g}(\vv{r},t)\equiv\frac{1}{\phi_g(\vv{r},t)}\int_{E_g}^{E_{g-1}}dE\int_{E_{g'}}^{E_{g'-1}}dE'\Sigma_s(\vv{r},E'\rightarrow E,t)\phi(\vv{r},E',t)
\eeq

\beq
\nu_g\Sigma_{f,g}\equiv\frac{1}{\phi_g(\vv{r},t)}\int_{E_g}^{E_{g-1}}dE\nu(E)\Sigma_f(\vv{r},E,t)\phi(\vv{r},E,t)
\eeq

\beq
\label{eq:DGroup}
D_g(\vv{r},t)\equiv\frac{\int_{E_g}^{E_{g-1}}dE D\nabla\phi(\vv{r},E,t)}{\int_{E_g}^{E_{g-1}}dE\phi(\vv{r},E,t)}
\eeq

\beq
\label{eq:VGroup}
\frac{1}{v_g}\equiv\frac{1}{\phi_g(\vv{r},t)}\int_{E_g}^{E_{g-1}}dE\frac{\phi(\vv{r},E,t)}{v(E)}
\eeq

Integrating the diffusion equation in Eq. \eqref{eq:DiffusionEquation} over a single energy group and applying these definitions gives the \gls{mg} diffusion equation:

\beqa
\label{eq:MGDiffusionEquation}
\frac{1}{v_g}\frac{\partial\phi_g(\vv{r},t)}{\partial t}-\nabla\cdot\left\lbrack D_g(\vv{r},t)\nabla\phi_g(\vv{r},t)\right\rbrack+\Sigma_{t,g}(\vv{r},t)\phi_g(\vv{r},t)=\hspace{2cm}\\
\sum_{g'=1}^G\Sigma_{s,g'\rightarrow g}(\vv{r},t)\phi_{g'}(\vv{r},t)+\left(1-\beta\right)\chi_{p,g}\sum_{g'=1}^G\nu\Sigma_{f,g'}(\vv{r},t)\phi_{g'}(\vv{r},t)+\sum_{j=1}^J\chi_{d,j,g}\lambda_jC_j(\vv{r},t)
\eeqa

where the time derivative and gradient were brought outside the energy integration since these operators do not depend on energy. The velocity is also brought outside the time derivative assuming the group structure is constant in time. The scattering and fission terms are obtained by breaking up the integrals over \(dE'\) into a finite series over the energy groups. A removal cross section is defined as all possible loss mechanisms from the energy group:

\beq
\label{eq:RemovalSigma}
\Sigma_{R,g}\equiv\Sigma_{t,g}-\Sigma_{s,g\rightarrow g}
\eeq

and inserted into Eq. \eqref{eq:MGDiffusionEquation} to give a second equivalent form:

\beqa
\label{eq:MGDiffusionEquation2}
\frac{1}{v_g}\frac{\partial\phi_g(\vv{r},t)}{\partial t}-\nabla\cdot\left\lbrack D_g(\vv{r},t)\nabla\phi_g(\vv{r},t)\right\rbrack+\Sigma_{R,g}(\vv{r},t)\phi_g(\vv{r},t)=\hspace{2cm}\\
\sum_{g'=1,g'\neq g}^G\Sigma_{s,g'\rightarrow g}(\vv{r},t)\phi_{g'}(\vv{r},t)+\left(1-\beta\right)\chi_{p,g}\sum_{g'=1}^G\nu\Sigma_{f,g'}(\vv{r},t)\phi_{g'}(\vv{r},t)+\sum_{j=1}^J\chi_{d,j,g}\lambda_jC_j(\vv{r},t)
\eeqa

The \gls{mg} constants defined in Eqs. \eqref{eq:FluxGroup}-\eqref{eq:VGroup} depend on both space and time, and they will be constant only in the case when the scalar flux is separable as a function of energy. In general, the scalar flux is not separable in energy and space-time, so the group constants will also be a function of position, and not just spectrum. The approximation of the \gls{mg} constants, without the use of stochastic methods that simply define tallies for the integral quantities, requires methods for approximating the scalar fluxes that appear in their definitions. This can usually be done by performing fairly simple calculations with a larger number of energy groups and computing constants for a coarser group structure by evaluating the integrals in Eqs. \eqref{eq:FluxGroup}-\eqref{eq:VGroup}. This process is known as a ``fine-group'' calculation followed by ``group collapsing.'' The larger the number of fine groups, the more crude the approximations to the energy-dependent scalar flux may be. For example, a rather crude approximation of \(\phi(E)\propto1/E\) is reasonable for the \(1 \text{ eV }\le E\le 10^5 \text{ eV}\) range, but such a crude approximation requires the use of a relatively fine group structure to capture the complicated resonance structures that a better flux representation would be able to capture with a coarser group structure. This process therefore first crudely treats the spatial dependence to obtain few-group constants that are then used to crudely treat the energy dependence in a more realistic spatially-dependent problem.

Most \gls{lwr} calculations use four energy groups - three in the fast range and a single thermal group. Gas-cooled reactors typically use between seven and nine groups due to the slightly harder spectrum, while fast reactors require 20+ groups due to the significant flux in the resonance range \cite{duderstadt}.

\subsubsection{Two-Group Diffusion Theory}
\label{sec:TwoGroupDT}

This section provides an example application of a two-group diffusion model. The coupled two-group equations are:

\begin{subequations}
\label{eq:MGFlux}
\begin{eqnarray}
\frac{1}{v_1}\frac{\partial\phi_1(\vv{r},t)}{\partial t}-\nabla\cdot\left\lbrack D_1(\vv{r},t)\nabla\phi_1(\vv{r},t)\right\rbrack+\Sigma_{R,1}(\vv{r},t)\phi_1(\vv{r},t)&=&
\nu\Sigma_{f,1}\phi_1(\vv{r},t)+\nu\Sigma_{f,2}\phi_2(\vv{r},t)\hspace{0.5cm}\\
\frac{1}{v_2}\frac{\partial\phi_2(\vv{r},t)}{\partial t}-\nabla\cdot\left\lbrack D_2(\vv{r},t)\nabla\phi_2(\vv{r},t)\right\rbrack+\Sigma_{a,2}(\vv{r},t)\phi_2(\vv{r},t)&=&\Sigma_{s,1\rightarrow2}\phi_1(\vv{r},t)
\end{eqnarray}
\end{subequations}

where it has been assumed that no upscattering from the thermal to the fast group occurs and all fission neutrons are born in the fast group. The external sources are assumed zero. Some simplified analysis of criticality for these coupled equations can be performed for a bare reactor, in which case the time dependence is neglected and the criticality eigenvalue \(1/k\) is inserted into Eq. \eqref{eq:MGFlux} to give:

\begin{subequations}
\label{eq:MGFluxCriticality}
\begin{eqnarray}
-\nabla\cdot\left\lbrack D_1\nabla\phi_1(\vv{r},t)\right\rbrack+\Sigma_{R,1}\phi_1(\vv{r},t)&=&
\frac{1}{k}\left\lbrack\nu\Sigma_{f,1}\phi_1(\vv{r},t)+\nu\Sigma_{f,2}\phi_2(\vv{r},t)\right\rbrack\\
-\nabla\cdot\left\lbrack D_2\nabla\phi_2(\vv{r},t)\right\rbrack+\Sigma_{a,2}\phi_2(\vv{r},t)&=&\Sigma_{s,1\rightarrow2}\phi_1(\vv{r},t)
\end{eqnarray}
\end{subequations}

Assuming both the fast and thermal flux are given by the same fundamental mode \(\psi\) in Eq. \eqref{eq:HomogEigen} with \(n=1\), Eqs. \eqref{eq:MGFluxCriticality}a and \eqref{eq:MGFluxCriticality}b can be combined and solved for \(k\) as:

\beq
\label{eq:k1k2}
k=\underbrace{\frac{\nu\Sigma_{f,1}/\Sigma_{R,1}}{1+L_1^2B^2}}_{k_1}+\underbrace{\frac{\Sigma_{s,1\rightarrow2}/\Sigma_{R,1}}{1+L_1^2B^2}\ \frac{\nu\Sigma_{f,2}/\Sigma_{a,2}}{1+L_2^2B^2}}_{k_2}
\eeq

where the diffusion lengths are now defined for each group in a manner similar to the definition in Eq. \eqref{eq:DiffusionLength}, except that the cross section in the denominator is now interpreted as the cross section that ``removes'' neutrons from that energy group. For a one-group analysis, Eq. \eqref{eq:DiffusionLength} still fits this definition. Eq. \eqref{eq:k1k2} shows that the overall \(k\) can be interpreted as the sum of the six-factor formulas relevant to the multiplication of neutrons in each group, here two groups. For example, multiplication in the fast group is only dictated by fast fission and removal of fast neutrons combined with fast neutron leakage, while multiplication in the thermal group is dictated by thermal fission and removal of thermal neutrons as well as production of thermal neutrons from downscattering of fast neutrons and the combined thermal and fast neutron leakage. It is clear from Eq. \eqref{eq:k1k2} that the resonance escape probability can be defined as:

\beq
p=\frac{\Sigma_{s,1\rightarrow2}}{\Sigma_{R,1}}
\eeq

and that the nonleakage probabilities of each of the groups are defined as:

\begin{subequations}
\begin{eqnarray}
P_{NL,th}&=&\frac{1}{1+L_2^2B^2}\\
P_{NL,f}&=&\frac{1}{1+L_1^2B^2}
\end{eqnarray}
\end{subequations}

Rearranging Eq. \eqref{eq:k1k2} to obtain the traditional six-factor formula in Eq. \eqref{eq:SixFactor} requires definition of the fast fission factor as:

\beq
\epsilon=\frac{k_1+k_2}{k_2}\ ,
\eeq

an intuitive definition based on the relative criticality of the two groups.

\subsubsection{One-and-a-Half-Group Diffusion Theory}

A further simplification of the two-group diffusion theory analysis shown in Section \ref{sec:TwoGroupDT} neglects thermal neutron diffusion relative to absorption, in which case the thermal flux is a scalar multiple of the fast flux:

\beq
\phi_1(\vv{r},t)=\frac{\Sigma_{s,1\rightarrow2}}{\Sigma_{a,2}}\phi_1(\vv{r},t)
\eeq

and Eq. \eqref{eq:MGFluxCriticality}a simplifies to:

\beq
-\nabla\cdot\left\lbrack D_1\nabla\phi_1(\vv{r},t)\right\rbrack+\Sigma_{R,1}\phi_1(\vv{r},t)=
\frac{1}{k}\left\lbrack\nu\Sigma_{f,1}\phi_1(\vv{r},t)+\nu\Sigma_{f,2}\frac{\Sigma_{s,1\rightarrow2}}{\Sigma_{a,2}}\phi_1(\vv{r},t)\right\rbrack\\
\eeq

This method is rarely used due to advances in computing capabilities, but may be instructional for hand-calculations.

\subsection{The One-Group Diffusion Equation}
For a single energy group, Eq. \eqref{eq:MGDiffusionEquation} simplifies to:

\beqa
\label{eq:1GDiffusionEquation}
&\frac{1}{v}\frac{\partial\phi(\vv{r},t)}{\partial t}-\nabla\cdot\left\lbrack D\nabla\phi(\vv{r},t)\right\rbrack+\Sigma_a(\vv{r},t)\phi(\vv{r},t)=\\
&\hspace{1cm}(1-\beta)\int_{4\pi}d\hO\nu\Sigma_f(\vv{r},t)\phi(\vv{r},\hO,t)+\int_{4\pi}d\hO\sum_{j=1}^J\chi_{d,j}(\hO)\lambda_jC_j(\vv{r},t)+S(\vv{r},t)
\eeqa

The one-group diffusion equation is parabolic, and if the time derivative is neglected, has the form of a Helmholtz equation. The one-group diffusion equation provides a convenient simplification to develop a better understanding of neutron transport by investigating simple problems with analytic solutions. This will be the goal of this section. 

Assuming uniform properties and dividing through by \(D\) shows that the neutron diffusivity, analogous to thermal diffusivity, is \(\Sigma_a/D\). The neutron diffusion length \(L\) is defined as follows for convenience:

\beq
\label{eq:DiffusionLength}
L\equiv\sqrt{\frac{D}{\Sigma_a}}
\eeq

\(L\) is proportional to the distance traveled by a neutron from a source to absorption; the exact proportionality differs based on the assumed coordinate system. The accuracy of a one-group diffusion model may be improved by replacing \(L^2\) that appears in the one-group formulation by the migration area \(M^2\), a linear combination of the diffusion lengths characterizing each energy group:

\beq
M^2=L_1^2+L_2^2
\eeq

The same conclusions regarding the proportionality of \(L\) to the distances traveled by neutrons from birth to absorption still hold for \(M\), but instead represent birth from fission in the fastest group to absorption in the most thermal group.

\subsubsection{One-Group Diffusion in Non-Multiplying Media}
\label{sec:NonMultiplyingDiffusion}
This section provides the derivation of several classical solutions to the one-group diffusion equation in non-multiplying media, i.e. media in which \(\Sigma_f=0\) and there are no delayed fission neutron sources. We will also assume that the problem can be well-approximated by a steady-state solution. For source problems, because the \gls{nte} is linear, the principle of superposition can be used given the analytic solution for a source to integrate over an arbitrary source distribution. This is especially simple in infinite geometries where the flux is only a function of the distance from the source; more general methods such as Green's functions are required for this process applied to finite domains.

\subsubsubsection{Point Source in Infinite Spherical Coordinates}
\label{sec:1GDEPtSrcSpherical}
The easiest solution is for a point source in spherical coordinates. For this system, the one-group diffusion equation may be solved in all regions of space except \(r=0\); the flux must be finite at all locations and the source is assumed to emit isotropically with magnitude \(S_0\) particles/second, giving the following \glspl{bc}:

\begin{subequations}
\label{eq:1GDESphericalBCs}
\begin{eqnarray}
\lim_{r\rightarrow 0}4\pi r^2J(r)&=&S_0\\
\lim_{r\rightarrow\infty}\phi(r)&=&0
\end{eqnarray}
\end{subequations}

where the \gls{bc} on the current at \(r=0\) is adjusted to obtain the correct units. The steady-state one-group diffusion equation in spherical coordinates to be solved is:

\beq
\label{eq:1GDESpherical}
\frac{1}{r^2}\frac{\partial}{\partial r}\left(r^2\frac{\partial\phi}{\partial r}\right)-\frac{1}{L^2}\phi=0
\eeq

Eq. \eqref{eq:1GDESpherical} has the following solution:

\beq
\phi(r)=\frac{1}{r}\left( C_1e^{-r/L}+\cancel{C_2e^{r/L}}\right)
\eeq

where application of Eq. \eqref{eq:1GDESphericalBCs}b requires the coefficient \(C_2=0\) because in the limit of \(r\rightarrow\infty\), an exponential grows faster than \(r\). Application of Eq. \eqref{eq:1GDESphericalBCs}a gives the following flux solution:

\beq
\phi(r)=\frac{S_0}{4\pi D}\frac{e^{-r/L}}{r}
\eeq

The flux falls exponentially, with an additional geometric attenuation due to the change in surface area with distance from the source. Some additional analysis will support the claim that \(L\) is proportional to the average distance traveled by a neutron from the source to absorption. The probability of absorption at \(r\pm dr\) is obtained simply by dividing the absorption interaction rate \(\Sigma_a\phi\) by the strength of the source and multiplying by the differential volume \(4\pi r^2dr\):

\beq
p_{abs}(r)dr=\frac{\Sigma_a}{4\pi D}\frac{e^{-r/L}}{r}4\pi r^2dr
\eeq

The average of the square of the distance traveled by a neutron from the point source until absorption, \(\langle r^2\rangle\), is computed simply by weighting \(r^2\) by the probability of absorption defined above:

\beqa
\langle r^2\rangle\equiv\frac{1}{L^2}\int_{0}^\infty e^{-r/L} r^3dr
=&6L^2
\eeqa

where three successive applications of integration by parts has been used. As can be seen, the neutron diffusion length is linearly proportional to the \gls{rms} distance from birth at a point source to absorption in a non-multiplying medium. This analysis illustrates that, while the total path length traveled is likely much larger due to scattering collisions that don't lead to the death of a neutron, the average distance traveled from a source can be assessed based on \(L\). In media poorly-suited to diffusion theory, the definition of \(L\) above provides a means of determining an approximate diffusion coefficient. For example, if \(L^2\) is taken to represent the average square of the distance traveled from birth to absorption, a diffusion coefficient can be estimated from transport theory as:

\beq
\frac{\Sigma_a}{D}=\frac{\int r^2\phi(\vv{r})d\vv{r}}{\int \phi(\vv{r})d\vv{r}}
\eeq

\subsubsubsection{Planar Source in Infinite Cartesian Coordinates}

Very similar to the point source in infinite spherical coordinates in Section \ref{sec:1GDEPtSrcSpherical}, a planar source with strength \(S_0\) neutrons per area\(\cdot\)second located at \(x=0\) in Cartesian coordinates leads to a problem that can be solved analytically for \(x\neq0\) using the one-group diffusion equation. The \glspl{bc} for this problem become:

\begin{subequations}
\label{eq:1GDECartBCs}
\begin{eqnarray}
\lim_{x\rightarrow0}J(x)&=&S_0/2\\
\lim_{x\rightarrow\infty}\phi(x)&=&0
\end{eqnarray}
\end{subequations}

And the neutron diffusion equation in Cartesian coordinates is:

\beq
\frac{\partial^2\phi}{\partial x^2}-\frac{1}{L^2}\phi=0
\eeq

This equation has the solution:

\beq
\phi(x)=C_1e^{-x/L}+\cancel{C_2e^{x/L}}
\eeq

where application of Eq. \eqref{eq:1GDECartBCs}b requires \(C_2=0\) and application of Eq. \eqref{eq:1GDECartBCs}a gives the solution:

\beq
\phi(x)=\frac{S_0L}{2D}e^{-x/L}
\eeq

Performing a similar analysis as in spherical coordinates, the probability of absorption at \(x\pm dx\) distance from the source is given by the absorption reaction rate divided by the source strength in that direction, multiplied by \(dx\):

\beq
p_{abs}(x)dx=\frac{\Sigma_aL}{2D}e^{-x/L}dx
\eeq

The average of the square of the distance traveled from the source to a point \(x\) is then defined as:

\beqa
\langle x^2\rangle\equiv&\int_0^\infty x^2p_{abs}(x)dx\\
=&L^2
\eeqa

Hence, the \gls{rms} distance traveled from the source to a point \(x\) is again proportional to \(L\).

\subsubsubsection{Planar Source in Finite Cartesian Coordinates}

For a planar source located at \(x=0\) surrounded by two layers of material combines the analysis performed for a slab in infinite geometry with interface conditions required between a region with different material properties:

\begin{subequations}
\begin{eqnarray}
\lim_{x\rightarrow0}J_1(x)&=&\frac{S_0}{2}\\
J_1(a/2)&=&J_2(a/2)\\
\phi_1(a/2)&=&\phi_2(a/2)\\
\phi_2(\tilde{a})=0
\end{eqnarray}
\end{subequations}

In general, multi-region problems can be simplified through the use of tabulated albedo functions. The albedo \(\alpha\) is defined as:

\beq
\label{eq:AlbedoDef}
\alpha\equiv\frac{J_{out}}{J_{in}}
\eeq

where \(J_{out}\) and \(J_{in}\) are the partial currents crossing an interface, corresponding respectively to different directions. Solution of a two-region one-group diffusion problem with the \glspl{bc} shown above gives the following expression for the albedo:

\beq
\alpha=\frac{1-\frac{2D}{L}\coth{\left(\frac{a}{L}\right)}}{1+\frac{2D}{L}\coth{\left(\frac{a}{L}\right)}}
\eeq

In the limit of the second region thickness tending to infinity, i.e. for an infinite reflecting region, the albedo approaches an asymptote of \((1-2D/L)/(1+2D/L)\). Note that a perfect reflector (100\% reflection of particles) only occurs for \(D/L\approx0\) (i.e. an insulator). In other words, \(\sqrt{\Sigma_aD}\approx0\), so an ideal reflector has both a small absorption cross section and a small diffusion coefficient. The asymptotic limits for common reflectors fall in the order \(\alpha_{\text{D$_2$O}}>\alpha_{\text{graphite}}>\alpha_{\text{H$_2$O}}\). Knowledge of the albedo can be used to replace a \gls{bc} on the edge of a domain through the use of partial current definitions and the definition of the albedo in Eq. \eqref{eq:AlbedoDef}.

\subsubsection{The Eigenfunction Expansion Method}

Section \ref{sec:NonMultiplyingDiffusion} provided several analytic solutions to the diffusion equation in non-multiplying media using the variation of constants technique. This section describes another solution technique known as the eigenfunction expansion method. This method is based on expanding the flux in an infinite series of the eigenfunctions of the homogeneous form of the differential equation. The homogeneous form of the one-group diffusion equation in non-multiplying media has eigenfunctions \(\psi_n\) and eigenvalues \(B_n^2\):

\beq
\label{eq:HomogEigen}
\frac{\partial\psi_n^2}{\partial x^2}+B_n^2\psi_n=0
\eeq

For a finite slab with vacuum conditions at \(\pm \tilde{a}/2\), two possible solutions exist, excluding the trivial solution:

\begin{subequations}
\label{eq:Eigenfunction1DSlab}
\begin{eqnarray}
\psi_n(x)&=&A_n\cos{\left(\frac{n\pi x}{\tilde{a}}\right)}\\
\psi_n(x)&=&A_n\sin{\left(\frac{n\pi x}{\tilde{a}}\right)}
\end{eqnarray}
\end{subequations}

where Eq. \eqref{eq:Eigenfunction1DSlab} applies for odd \(n\) and Eq. \eqref{eq:Eigenfunction1DSlab}b for even \(n\). The eigenvalues corresponding to these eigenfunctions are:

\beq
B_n^2=\left(\frac{n\pi}{\tilde{a}}\right)^2
\eeq

Given the symmetry of the diffusion operator, the eigenfunctions of the Laplacian comprise a complete orthogonal basis set. Therefore, expand both the flux and source for a general non-multiplying fixed source problem, and insert into the governing equation to obtain an expression for the coefficients on the flux expansion:

\beqa
-\frac{1}{D}\sum_{n=1}^nS_n\psi_n=&\sum_{i=1}^nA_n\left(\frac{\partial^2\psi}{\partial x^2}-\frac{1}{L^2}\psi_n\right)\\
=&-\sum_{i=1}^nA_n\left(B^2+\frac{1}{L^2}\psi_n\right)\\
\eeqa

where Eq. \eqref{eq:HomogEigen} was inserted to provide a relationship between \(\psi_n\) and \(B_n\). Therefore, the flux distribution for an arbitrary source distribution in a finite geometry can be determined by expanding both the flux and source as an infinite series of the eigenfunctions of the homogeneous operator:

\beq
\phi(x)=\sum_{i=1}^n\frac{S_n/\Sigma_a}{1+L^2B^2}\psi_n(x)
\eeq

where the coefficients \(S_n\) are determined by application of orthogonality to the known source distribution.